<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Structured Schedule</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root {
    --accent: #3b82f6;
    --accent-glow: rgba(59,130,246,0.22);
    --bg-page: #f0f4f8;
    --card-bg: #ffffff;
    --text-main: #1e293b;
    --text-muted: #64748b;
    --radius: 16px;
    --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
    --shadow-md: 0 4px 6px rgba(0,0,0,0.08);
    --shadow-lg: 0 10px 15px rgba(0,0,0,0.06);
    --success: #10b981;
    --warning: #f59e0b;
    --purple: #8b5cf6;
  }
  * { box-sizing: border-box; }
  body {
    margin: 0; padding: 20px; background: var(--bg-page); color: var(--text-main);
    font-family: 'Inter', sans-serif; min-height: 100vh; display:flex; justify-content:center;
  }
  .app { width:100%; max-width:980px; animation: fadeIn .5s ease-out; }

  /* Header */
  header { margin-bottom: 24px; display:flex; flex-direction:column; align-items:center; text-align:center; gap:12px; }
  h1 { font-size:44px; margin:0; font-weight:900; color:#0f172a; }
  .tagline { font-weight:900; color:#000; margin-top:6px; font-size:18px; display:flex; align-items:center; gap:10px; text-transform:uppercase; letter-spacing:-0.01em; }

  .controls { display:flex; gap:8px; background:white; padding:8px; border-radius:12px; box-shadow:var(--shadow-sm); margin-top:8px; align-items:center; flex-wrap:wrap; }
  button.btn { border:none; background:transparent; padding:8px 12px; border-radius:8px; font-weight:700; color:var(--text-muted); cursor:pointer; }
  button.btn:hover { background:#f1f5f9; color:var(--text-main); }
  button.btn.primary { background:var(--accent); color:#fff; box-shadow:0 6px 14px var(--accent-glow); }

  /* Card + tabs */
  .main-card { background:var(--card-bg); border-radius:16px; box-shadow:var(--shadow-lg); overflow:hidden; }
  .tabs { display:flex; background:#f8fafc; border-bottom:1px solid #e2e8f0; padding:6px; gap:6px; }
  .tabs button { flex:1; border:none; background:transparent; padding:12px; font-weight:800; color:var(--text-muted); cursor:pointer; border-radius:10px; }
  .tabs button[aria-selected="true"] { color:var(--accent); background:white; box-shadow:0 -4px 6px rgba(0,0,0,0.03); }

  .tabpanel { display:none; padding:20px; }
  .tabpanel.active { display:block; }

  .session-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:18px; padding-bottom:12px; border-bottom:2px dashed #e2e8f0; gap:12px; }
  .session-badge-title { display:flex; align-items:center; gap:10px; font-weight:800; font-size:18px; }
  .session-meta { color:var(--text-muted); font-size:14px; padding-left:18px; }

  .session-timer { background:#f1f5f9; padding:10px 14px; border-radius:10px; text-align:right; min-width:160px; }
  .session-timer div { font-size:28px; font-weight:900; color:var(--accent); line-height:1; }
  .session-timer span{ display:block; font-size:12px; font-weight:700; color:var(--text-muted); text-transform:uppercase; }

  /* Schedule items */
  .schedule-list { display:flex; flex-direction:column; gap:14px; }
  .item { background:white; border:1px solid #e2e8f0; border-radius:12px; padding:18px; display:grid; grid-template-columns:140px 1fr auto; gap:16px; position:relative; transition:transform .18s; overflow:hidden; }
  .item:hover { transform:translateY(-2px); box-shadow:var(--shadow-md); border-color:#cbd5e1; }
  .item.past { opacity:.6; background:#fafafa; }
  .item.current { border-color:var(--accent); background:linear-gradient(to right,#eff6ff,#fff); box-shadow:0 0 0 1px var(--accent), var(--shadow-md); }
  .item.current::before { content:''; position:absolute; left:0; top:0; bottom:0; width:5px; background:var(--accent); }
  .time-col { display:flex; flex-direction:column; justify-content:center; font-weight:800; color:#334155; }
  .time-col span:first-child { font-size:1.3rem; margin-bottom:4px; }
  .time-col span:last-child { font-size:.9rem; font-weight:600; opacity:.6; }

  .content-col { display:flex; flex-direction:column; justify-content:center; }
  .task-title { font-weight:800; font-size:1.05rem; margin-bottom:6px; color:#0f172a; }
  .meta-row { display:flex; gap:12px; align-items:center; font-size:.9rem; color:var(--text-muted); }
  .progress-track { width:100%; height:8px; background:#e2e8f0; border-radius:10px; overflow:hidden; margin-top:10px; }
  .progress-fill { height:100%; width:0%; background:var(--accent); border-radius:10px; transition:width 1s linear; }

  .toggle-btn { background:#f1f5f9; border:none; width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; color:var(--text-muted); }
  .toggle-btn:hover{ background:#e2e8f0; color:var(--text-main); }
  .item.open .toggle-btn { transform:rotate(180deg); background:var(--accent); color:white; }

  .detail-wrapper { grid-column:1 / -1; max-height:0; overflow:hidden; transition:max-height .35s ease, opacity .2s ease; opacity:0; }
  .item.open .detail-wrapper { max-height:420px; opacity:1; margin-top:12px; border-top:1px solid #f1f5f9; padding-top:12px; }
  .detail-content { font-size:1rem; color:#475569; line-height:1.6; background:#f8fafc; padding:14px; border-radius:8px; }

  /* small EndMerge button style */
  .end-merge-btn { margin-left:8px; width:40px; height:40px; border-radius:50%; background:#fff; border:1px solid #e6eaf6; cursor:pointer; display:flex; align-items:center; justify-content:center; color:var(--text-muted); }
  .end-merge-btn:hover { background:#eef2ff; color:var(--accent); }

  .footer-status { padding:14px 24px; background:#f8fafc; display:flex; justify-content:flex-end; align-items:center; border-top:1px solid #e2e8f0; color:var(--text-muted); font-size:.95rem; font-weight:700; }

  /* small responsive */
  @media (max-width:640px) {
    .item { grid-template-columns:1fr auto; gap:10px; }
    .time-col { grid-column:1 / -1; flex-direction:row; justify-content:space-between; align-items:center; margin-bottom:8px; padding-bottom:8px; border-bottom:1px solid #f1f5f9; }
    .time-col span:first-child { font-size:1.05rem; }
  }

  @keyframes fadeIn { from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:none} }
</style>
</head>
<body>
<div class="app">
  <header>
    <h1>Structured Schedule</h1>
    <div class="tagline">‚ö°Ô∏è Dec 31 make it counts ‚ö°Ô∏è</div>

    <div class="controls" role="group" aria-label="controls">
      <button class="btn" id="expandAll">Expand All</button>
      <button class="btn" id="collapseAll">Collapse All</button>
      <button class="btn primary" id="nowBtn">Jump to Now</button>

      <!-- small toggles -->
      <div style="display:flex;gap:8px;align-items:center;margin-left:8px">
        <label style="font-weight:700;color:var(--text-muted);font-size:13px;margin-right:6px">Show remaining</label>
        <input id="showRemainingToggle" type="checkbox" checked />
      </div>
      <div style="display:flex;gap:8px;align-items:center;margin-left:8px">
        <label style="font-weight:700;color:var(--text-muted);font-size:13px;margin-right:6px">Notify</label>
        <input id="notifyToggle" type="checkbox" />
      </div>
      <div style="display:flex;gap:8px;align-items:center;margin-left:8px">
        <label style="font-weight:700;color:var(--text-muted);font-size:13px;margin-right:6px">Sound</label>
        <input id="soundToggle" type="checkbox" checked />
      </div>
    </div>
  </header>

  <div class="main-card">
    <div class="tabs" role="tablist">
      <button role="tab" aria-selected="true" data-target="morning">Morning</button>
      <button role="tab" aria-selected="false" data-target="afternoon">Afternoon</button>
      <button role="tab" aria-selected="false" data-target="evening">Evening</button>
    </div>

    <!-- MORNING -->
    <div id="morning" class="tabpanel active">
      <div class="session-header">
        <div>
          <div class="session-badge-title"><div class="dot" style="background:var(--success)"></div><span>Morning ‚Äî Deep Technical Dive</span></div>
          <div class="session-meta">Focus: concentrated technical practice & sessions</div>
        </div>
        <div class="session-timer"><div id="morningRemaining">--:--</div><span>Session Remaining</span></div>
      </div>

      <div class="schedule-list" id="morningList">
        <div class="item" data-id="m1" data-start="08:30 AM" data-end="08:45 AM">
          <div class="time-col"><span>08:30 AM</span><span>08:45 AM</span></div>
          <div class="content-col">
            <div class="task-title">ü•£ Breakfast / Start</div>
            <div class="meta-row"><span>Duration: 15 mins</span><span class="status-text">Pending</span></div>
            <div class="progress-track"><div class="progress-fill"></div></div>
          </div>
          <div style="display:flex;flex-direction:column;gap:8px;align-items:center">
            <button class="toggle-btn" aria-label="Toggle details">
              <svg width="12" height="8" viewBox="0 0 12 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M1 1L6 6L11 1"/></svg>
            </button>
            <button class="end-merge-btn" title="End & add time to next">‚§¥</button>
          </div>
          <div class="detail-wrapper"><div class="detail-content">Light breakfast, set up environment, quick review of goals.</div></div>
        </div>

        <div class="item" data-id="m2" data-start="08:45 AM" data-end="11:00 AM">
          <div class="time-col"><span>08:45 AM</span><span>11:00 AM</span></div>
          <div class="content-col">
            <div class="task-title">üèãÔ∏è‚Äç‚ôÇÔ∏è Technical Workouts (Part 1)</div>
            <div class="meta-row"><span>Duration: 2 hrs 15 mins</span><span class="status-text">Pending</span></div>
            <div class="progress-track"><div class="progress-fill"></div></div>
          </div>
          <div style="display:flex;flex-direction:column;gap:8px;align-items:center">
            <button class="toggle-btn"><svg width="12" height="8" viewBox="0 0 12 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M1 1L6 6L11 1"/></svg></button>
            <button class="end-merge-btn" title="End & add time to next">‚§¥</button>
          </div>
          <div class="detail-wrapper"><div class="detail-content">Deep practice: systems, algorithms, problem breakdowns.</div></div>
        </div>

        <div class="item" data-id="m3" data-start="11:00 AM" data-end="11:15 AM">
          <div class="time-col"><span>11:00 AM</span><span>11:15 AM</span></div>
          <div class="content-col">
            <div class="task-title">‚òï Morning Tea Break</div>
            <div class="meta-row"><span>Duration: 15 mins</span><span class="status-text">Pending</span></div>
            <div class="progress-track"><div class="progress-fill"></div></div>
          </div>
          <div style="display:flex;flex-direction:column;gap:8px;align-items:center">
            <button class="toggle-btn"><svg width="12" height="8" viewBox="0 0 12 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M1 1L6 6L11 1"/></svg></button>
            <button class="end-merge-btn" title="End & add time to next">‚§¥</button>
          </div>
          <div class="detail-wrapper"><div class="detail-content">Short reset: walk/stretch, hydrate.</div></div>
        </div>

        <div class="item" data-id="m4" data-start="11:15 AM" data-end="01:00 PM">
          <div class="time-col"><span>11:15 AM</span><span>01:00 PM</span></div>
          <div class="content-col">
            <div class="task-title">üèãÔ∏è‚Äç‚ôÇÔ∏è Technical Workouts (Part 2)</div>
            <div class="meta-row"><span>Duration: 1 hr 45 mins</span><span class="status-text">Pending</span></div>
            <div class="progress-track"><div class="progress-fill"></div></div>
          </div>
          <div style="display:flex;flex-direction:column;gap:8px;align-items:center">
            <button class="toggle-btn"><svg width="12" height="8" viewBox="0 0 12 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M1 1L6 6L11 1"/></svg></button>
            <button class="end-merge-btn" title="End & add time to next">‚§¥</button>
          </div>
          <div class="detail-wrapper"><div class="detail-content">Continue targeted practice and problem solving.</div></div>
        </div>
      </div>
    </div>

    <!-- AFTERNOON -->
    <div id="afternoon" class="tabpanel">
      <div class="session-header">
        <div>
          <div class="session-badge-title"><div class="dot" style="background:var(--warning)"></div><span>Afternoon ‚Äî Communication & Projects</span></div>
          <div class="session-meta">Focus: collaboration, projects, analytics</div>
        </div>
        <div class="session-timer"><div id="afternoonRemaining">--:--</div><span>Session Remaining</span></div>
      </div>

      <div class="schedule-list" id="afternoonList">
        <div class="item" data-id="a1" data-start="01:00 PM" data-end="02:00 PM">
          <div class="time-col"><span>01:00 PM</span><span>02:00 PM</span></div>
          <div class="content-col">
            <div class="task-title">üçõ Lunch Break</div>
            <div class="meta-row"><span>Duration: 1 hr</span><span class="status-text">Pending</span></div>
            <div class="progress-track"><div class="progress-fill"></div></div>
          </div>
          <div style="display:flex;flex-direction:column;gap:8px;align-items:center">
            <button class="toggle-btn"><svg width="12" height="8" viewBox="0 0 12 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M1 1L6 6L11 1"/></svg></button>
            <button class="end-merge-btn" title="End & add time to next">‚§¥</button>
          </div>
          <div class="detail-wrapper"><div class="detail-content">Take a full break, step away from the screen.</div></div>
        </div>

        <div class="item" data-id="a2" data-start="02:00 PM" data-end="03:00 PM">
          <div class="time-col"><span>02:00 PM</span><span>03:00 PM</span></div>
          <div class="content-col">
            <div class="task-title">üó£Ô∏è Communication Session (Fixed)</div>
            <div class="meta-row"><span>Duration: 1 hr</span><span class="status-text">Pending</span></div>
            <div class="progress-track"><div class="progress-fill"></div></div>
          </div>
          <div style="display:flex;flex-direction:column;gap:8px;align-items:center">
            <button class="toggle-btn"><svg width="12" height="8" viewBox="0 0 12 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M1 1L6 6L11 1"/></svg></button>
            <button class="end-merge-btn" title="End & add time to next">‚§¥</button>
          </div>
          <div class="detail-wrapper"><div class="detail-content">Meetings, call sessions, updates.</div></div>
        </div>

        <div class="item" data-id="a3" data-start="03:00 PM" data-end="05:00 PM">
          <div class="time-col"><span>03:00 PM</span><span>05:00 PM</span></div>
          <div class="content-col">
            <div class="task-title">üíª Project & Data Analytics Revision</div>
            <div class="meta-row"><span>Duration: 2 hrs</span><span class="status-text">Pending</span></div>
            <div class="progress-track"><div class="progress-fill"></div></div>
          </div>
          <div style="display:flex;flex-direction:column;gap:8px;align-items:center">
            <button class="toggle-btn"><svg width="12" height="8" viewBox="0 0 12 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M1 1L6 6L11 1"/></svg></button>
            <button class="end-merge-btn" title="End & add time to next">‚§¥</button>
          </div>
          <div class="detail-wrapper"><div class="detail-content">Hands-on project work, data checks, reports.</div></div>
        </div>
      </div>
    </div>

    <!-- EVENING -->
    <div id="evening" class="tabpanel">
      <div class="session-header">
        <div>
          <div class="session-badge-title"><div class="dot" style="background:var(--purple)"></div><span>Evening ‚Äî Skills, Logic & Review</span></div>
          <div class="session-meta">Focus: practice, extra skills, revision</div>
        </div>
        <div class="session-timer"><div id="eveningRemaining">--:--</div><span>Session Remaining</span></div>
      </div>

      <div class="schedule-list" id="eveningList">
        <div class="item" data-id="e1" data-start="05:00 PM" data-end="05:15 PM">
          <div class="time-col"><span>05:00 PM</span><span>05:15 PM</span></div>
          <div class="content-col">
            <div class="task-title">‚òï Evening Tea Break</div>
            <div class="meta-row"><span>Duration: 15 mins</span><span class="status-text">Pending</span></div>
            <div class="progress-track"><div class="progress-fill"></div></div>
          </div>
          <div style="display:flex;flex-direction:column;gap:8px;align-items:center">
            <button class="toggle-btn"><svg width="12" height="8" viewBox="0 0 12 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M1 1L6 6L11 1"/></svg></button>
            <button class="end-merge-btn" title="End & add time to next">‚§¥</button>
          </div>
          <div class="detail-wrapper"><div class="detail-content">Quick reset, short walk.</div></div>
        </div>

        <div class="item" data-id="e2" data-start="05:15 PM" data-end="07:00 PM">
          <div class="time-col"><span>05:15 PM</span><span>07:00 PM</span></div>
          <div class="content-col">
            <div class="task-title">üèãÔ∏è‚Äç‚ôÇÔ∏è Technical Workouts (Part 3)</div>
            <div class="meta-row"><span>Duration: 1 hr 45 mins</span><span class="status-text">Pending</span></div>
            <div class="progress-track"><div class="progress-fill"></div></div>
          </div>
          <div style="display:flex;flex-direction:column;gap:8px;align-items:center">
            <button class="toggle-btn"><svg width="12" height="8" viewBox="0 0 12 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M1 1L6 6L11 1"/></svg></button>
            <button class="end-merge-btn" title="End & add time to next">‚§¥</button>
          </div>
          <div class="detail-wrapper"><div class="detail-content">Focused problem-solving, practice rounds.</div></div>
        </div>

        <div class="item" data-id="e3" data-start="07:00 PM" data-end="08:00 PM">
          <div class="time-col"><span>07:00 PM</span><span>08:00 PM</span></div>
          <div class="content-col">
            <div class="task-title">üêç Python, DSA & LeetCode</div>
            <div class="meta-row"><span>Duration: 1 hr</span><span class="status-text">Pending</span></div>
            <div class="progress-track"><div class="progress-fill"></div></div>
          </div>
          <div style="display:flex;flex-direction:column;gap:8px;align-items:center">
            <button class="toggle-btn"><svg width="12" height="8" viewBox="0 0 12 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M1 1L6 6L11 1"/></svg></button>
            <button class="end-merge-btn" title="End & add time to next">‚§¥</button>
          </div>
          <div class="detail-wrapper"><div class="detail-content">Targeted coding practice‚Äîone problem deep.</div></div>
        </div>

        <div class="item" data-id="e4" data-start="08:00 PM" data-end="08:30 PM">
          <div class="time-col"><span>08:00 PM</span><span>08:30 PM</span></div>
          <div class="content-col">
            <div class="task-title">ü§ñ Miscellaneous</div>
            <div class="meta-row"><span>Duration: 30 mins</span><span class="status-text">Pending</span></div>
            <div class="progress-track"><div class="progress-fill"></div></div>
          </div>
          <div style="display:flex;flex-direction:column;gap:8px;align-items:center">
            <button class="toggle-btn"><svg width="12" height="8" viewBox="0 0 12 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M1 1L6 6L11 1"/></svg></button>
            <button class="end-merge-btn" title="End & add time to next">‚§¥</button>
          </div>
          <div class="detail-wrapper"><div class="detail-content">Catch-all for small tasks, quick admin.</div></div>
        </div>

        <div class="item" data-id="e5" data-start="08:30 PM" data-end="09:15 PM">
          <div class="time-col"><span>08:30 PM</span><span>09:15 PM</span></div>
          <div class="content-col">
            <div class="task-title">üìä Extra Skills (Excel/Tools)</div>
            <div class="meta-row"><span>Duration: 45 mins</span><span class="status-text">Pending</span></div>
            <div class="progress-track"><div class="progress-fill"></div></div>
          </div>
          <div style="display:flex;flex-direction:column;gap:8px;align-items:center">
            <button class="toggle-btn"><svg width="12" height="8" viewBox="0 0 12 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M1 1L6 6L11 1"/></svg></button>
            <button class="end-merge-btn" title="End & add time to next">‚§¥</button>
          </div>
          <div class="detail-wrapper"><div class="detail-content">Tool practice ‚Äî Excel dashboards, shortcuts, macros.</div></div>
        </div>

        <div class="item" data-id="e6" data-start="09:15 PM" data-end="10:00 PM">
          <div class="time-col"><span>09:15 PM</span><span>10:00 PM</span></div>
          <div class="content-col">
            <div class="task-title">üîÑ Dedicated Revision (Week 1 - Week 25)</div>
            <div class="meta-row"><span>Duration: 45 mins</span><span class="status-text">Pending</span></div>
            <div class="progress-track"><div class="progress-fill"></div></div>
          </div>
          <div style="display:flex;flex-direction:column;gap:8px;align-items:center">
            <button class="toggle-btn"><svg width="12" height="8" viewBox="0 0 12 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M1 1L6 6L11 1"/></svg></button>
            <button class="end-merge-btn" title="End & add time to next">‚§¥</button>
          </div>
          <div class="detail-wrapper"><div class="detail-content">Revision cycle, spaced repetition for long-term retention.</div></div>
        </div>

      </div>
    </div>

    <div class="footer-status"><span id="totalDay">Day total: --</span></div>
  </div>
</div>

<script>
/* ------------------ Utilities ------------------ */
function parseTime12(str) {
  const parts = (str||'').trim().match(/^(\d{1,2}):(\d{2})\s*([AP]M)$/i);
  if(!parts) return null;
  let hh = parseInt(parts[1],10), mm = parseInt(parts[2],10), ap = parts[3].toUpperCase();
  if(ap === 'AM'){ if(hh === 12) hh = 0; } else { if(hh !== 12) hh += 12; }
  const d = new Date();
  d.setHours(hh, mm, 0, 0);
  return d;
}
function formatTime12(d){
  const hh24 = d.getHours(), mm = d.getMinutes();
  const ap = hh24 >= 12 ? 'PM' : 'AM';
  let hh = hh24 % 12; if(hh === 0) hh = 12;
  return `${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')} ${ap}`;
}
function formatHMS(sec){
  if(sec < 0) sec = 0;
  const h = Math.floor(sec/3600), m = Math.floor((sec%3600)/60), s = Math.floor(sec%60);
  if(h>0) return `${h}h ${m}m ${s}s`;
  if(m>0) return `${m}m ${s}s`;
  return `${s}s`;
}

/* ------------------ Persistence ------------------ */
const SCHED_KEY = 'structured_schedule_v2';
const PREFS_KEY = 'structured_schedule_prefs_v2';

function saveSchedule(){
  const arr = Array.from(document.querySelectorAll('.item')).map(it => ({
    id: it.dataset.id,
    start: it.dataset.start,
    end: it.dataset.end,
    title: it.querySelector('.task-title') ? it.querySelector('.task-title').innerText : ''
  }));
  localStorage.setItem(SCHED_KEY, JSON.stringify(arr));
}
function loadSchedule(){
  const raw = localStorage.getItem(SCHED_KEY);
  if(!raw) return;
  try{
    const arr = JSON.parse(raw);
    arr.forEach(obj=>{
      const it = document.querySelector(`.item[data-id="${obj.id}"]`);
      if(it && obj.start && obj.end){
        it.dataset.start = obj.start; it.dataset.end = obj.end;
        const spans = it.querySelectorAll('.time-col span');
        if(spans.length >= 2){ spans[0].textContent = obj.start; spans[1].textContent = obj.end; }
        const titleEl = it.querySelector('.task-title');
        if(titleEl && obj.title) titleEl.innerText = obj.title;
      }
    });
  }catch(e){ console.warn('loadSchedule fail', e); }
}
function savePrefs(){ localStorage.setItem(PREFS_KEY, JSON.stringify({ showRemaining: showRemainingToggle.checked, notify: notifyToggle.checked, sound: soundToggle.checked })); }
function loadPrefs(){
  const raw = localStorage.getItem(PREFS_KEY);
  if(!raw) return;
  try{
    const p = JSON.parse(raw);
    if(typeof p.showRemaining === 'boolean') showRemainingToggle.checked = p.showRemaining;
    if(typeof p.notify === 'boolean') notifyToggle.checked = p.notify;
    if(typeof p.sound === 'boolean') soundToggle.checked = p.sound;
  }catch(e){}
}

/* ------------------ Editor (double-click times) ------------------ */
const editor = document.createElement('div');
editor.style.position='absolute'; editor.style.display='none'; editor.style.zIndex=9999;
editor.style.background='#fff'; editor.style.border='1px solid #e6edf6'; editor.style.padding='10px'; editor.style.borderRadius='8px'; editor.style.boxShadow='0 8px 24px rgba(2,6,23,0.08)';

editor.innerHTML = `
  <div style="font-weight:800;margin-bottom:8px">Edit times (12-hour)</div>
  <input id="edStart" placeholder="08:30 AM" style="padding:8px;border-radius:6px;border:1px solid #e6edf6;width:220px;margin-bottom:8px">
  <input id="edEnd" placeholder="09:15 AM" style="padding:8px;border-radius:6px;border:1px solid #e6edf6;width:220px;margin-bottom:8px">
  <div style="display:flex;gap:8px;justify-content:flex-end">
    <button id="edCancel" style="padding:8px 10px;border-radius:8px;border:none;background:#f1f5f9;cursor:pointer">Cancel</button>
    <button id="edSave" style="padding:8px 10px;border-radius:8px;border:none;background:var(--accent);color:#fff;cursor:pointer">Save</button>
  </div>
  <div id="edErr" style="color:#dc2626;margin-top:8px;display:none"></div>
`;
document.body.appendChild(editor);
const edStart = editor.querySelector('#edStart'), edEnd = editor.querySelector('#edEnd'), edSave = editor.querySelector('#edSave'), edCancel = editor.querySelector('#edCancel'), edErr = editor.querySelector('#edErr');
let editingItem = null;

function openEditorFor(item){
  editingItem = item;
  edErr.style.display='none';
  edStart.value = item.dataset.start || '';
  edEnd.value = item.dataset.end || '';
  editor.style.display = 'block';
  // position: near item
  const rect = item.getBoundingClientRect();
  const left = Math.min(window.innerWidth - 260, rect.right + 12);
  editor.style.left = (left) + 'px';
  editor.style.top = (rect.top + window.scrollY) + 'px';
  edStart.focus();
}
function closeEditor(){ editor.style.display='none'; editingItem = null; edErr.style.display='none'; }

document.addEventListener('dblclick', (e)=>{
  const t = e.target.closest('.time-col');
  if(!t) return;
  const item = t.closest('.item');
  openEditorFor(item);
});
edCancel.addEventListener('click', closeEditor);
edSave.addEventListener('click', () => {
  const s = edStart.value.trim().toUpperCase(), e = edEnd.value.trim().toUpperCase();
  if(!/^(0?\d|1[0-2]):[0-5]\d\s?(AM|PM)$/i.test(s) || !/^(0?\d|1[0-2]):[0-5]\d\s?(AM|PM)$/i.test(e)){
    edErr.style.display='block'; edErr.textContent='Please use valid 12-hour time like 08:30 AM';
    return;
  }
  const sd = parseTime12(s), ed = parseTime12(e);
  if(!sd || !ed || sd >= ed){ edErr.style.display='block'; edErr.textContent='End must be after Start'; return; }
  // apply
  editingItem.dataset.start = s; editingItem.dataset.end = e;
  const spans = editingItem.querySelectorAll('.time-col span'); if(spans.length>=2){ spans[0].textContent = s; spans[1].textContent = e; }
  saveSchedule();
  updateAllTimers();
  closeEditor();
});
document.addEventListener('keydown', (ev) => { if(ev.key === 'Escape') closeEditor(); });

/* ------------------ Toggles ------------------ */
const showRemainingToggle = document.getElementById('showRemainingToggle');
const notifyToggle = document.getElementById('notifyToggle');
const soundToggle = document.getElementById('soundToggle');
showRemainingToggle.addEventListener('change', ()=> {
  document.querySelectorAll('.remaining-txt').forEach(r => r.style.display = showRemainingToggle.checked ? 'block' : 'none');
  savePrefs();
});
notifyToggle.addEventListener('change', async ()=>{
  if(notifyToggle.checked && "Notification" in window && Notification.permission !== 'granted'){
    try{ const p = await Notification.requestPermission(); if(p !== 'granted') notifyToggle.checked = false; }
    catch(e){ notifyToggle.checked = false; }
  }
  savePrefs();
});
soundToggle.addEventListener('change', savePrefs);
loadPrefs();

/* ------------------ Toggle details & End & Merge button wiring ------------------ */
document.querySelectorAll('.toggle-btn').forEach(btn => {
  btn.addEventListener('click', (ev) => {
    ev.stopPropagation();
    const item = btn.closest('.item'); item.classList.toggle('open');
  });
});
document.querySelectorAll('.item').forEach(item => {
  item.addEventListener('click', (e) => {
    if(e.target.closest('.toggle-btn') || e.target.closest('.end-merge-btn')) return;
    item.classList.toggle('open');
  });
});

/* End & Merge implementation */
function findNextItem(item){
  let next = item.nextElementSibling;
  while(next && !next.classList.contains('item')) next = next.nextElementSibling;
  return next;
}
function itemDurationMs(item){
  const s = parseTime12(item.dataset.start), e = parseTime12(item.dataset.end);
  if(!s||!e) return 0;
  return Math.max(0, e - s);
}
function setItemEnd(item, date){
  const newEnd = formatTime12(date);
  item.dataset.end = newEnd;
  const spans = item.querySelectorAll('.time-col span');
  if(spans.length>=2) spans[1].textContent = newEnd;
}
function animateRemove(item){
  item.style.transition = 'opacity 220ms, transform 220ms';
  item.style.opacity = '0'; item.style.transform = 'translateY(-10px)';
  setTimeout(()=> { const p = item.parentElement; if(p) p.removeChild(item); }, 220);
}
function mergeItemWithNext(item){
  const next = findNextItem(item);
  if(!next){ alert('No next consecutive session found in this block. Cannot merge.'); return; }
  const durMs = itemDurationMs(item);
  if(durMs <= 0){ animateRemove(item); saveSchedule(); updateAllTimers(); return; }
  if(!confirm(`End "${item.querySelector('.task-title').innerText.trim()}" and add ${Math.round(durMs/60000)} mins to "${next.querySelector('.task-title').innerText.trim()}"?`)) return;
  const nextEnd = parseTime12(next.dataset.end);
  if(!nextEnd){ alert('Next session has invalid end time.'); return; }
  const newNextEnd = new Date(nextEnd.getTime() + durMs);
  setItemEnd(next, newNextEnd);
  animateRemove(item);
  saveSchedule();
  updateAllTimers();
}
/* attach to existing end-merge buttons */
document.querySelectorAll('.end-merge-btn').forEach(btn => {
  btn.addEventListener('click', (ev)=>{
    ev.stopPropagation();
    const item = btn.closest('.item');
    mergeItemWithNext(item);
  });
});

/* ------------------ Notifications + beep ------------------ */
let audioCtx = null;
function initBeep(){
  try{
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }catch(e){ audioCtx = null; }
}
function playBeep(){
  if(!audioCtx) return;
  const o = audioCtx.createOscillator(), g = audioCtx.createGain();
  o.type = 'sine'; o.frequency.value = 880;
  o.connect(g); g.connect(audioCtx.destination);
  g.gain.value = 0.0001; o.start();
  const now = audioCtx.currentTime;
  g.gain.exponentialRampToValueAtTime(0.2, now + 0.02);
  g.gain.exponentialRampToValueAtTime(0.0001, now + 0.6);
  setTimeout(()=> o.stop(), 700);
}
initBeep();

/* ------------------ Main timer & UI update ------------------ */
let prevStarted = {}; // track started states for notifications
function updateAllTimers(){
  const now = new Date(); let dayTotalMins = 0;
  document.querySelectorAll('.item').forEach(item => {
    const s = parseTime12(item.dataset.start), e = parseTime12(item.dataset.end);
    if(!s || !e) return;
    const totalSec = Math.max(1, Math.round((e - s)/1000));
    const elapsed = Math.round((now - s)/1000);
    const remaining = Math.round((e - now)/1000);

    dayTotalMins += Math.max(0, Math.round((e - s)/60000));

    // status & progress
    item.classList.remove('past','current','future');
    const status = item.querySelector('.status-text'), fill = item.querySelector('.progress-fill');

    if(now > e){
      item.classList.add('past');
      if(status) status.textContent = 'Ended';
      if(fill){ fill.style.width = '100%'; fill.style.background = '#cbd5e1'; }
    } else if(now < s){
      item.classList.add('future');
      const diffMin = Math.round((s - now)/60000);
      if(status) status.textContent = diffMin>60 ? `in ${Math.round(diffMin/60)}h ${diffMin%60}m` : `in ${diffMin}m`;
      if(fill){ fill.style.width = '0%'; fill.style.background = 'var(--accent)'; }
    } else {
      item.classList.add('current');
      if(status) status.textContent = 'Active';
      const pct = Math.max(0, Math.min(100, (elapsed/totalSec)*100));
      if(fill){ fill.style.width = pct + '%'; fill.style.background = 'var(--accent)'; }
    }

    // per-item remaining text (simple) controlled by toggle
    let rem = item.querySelector('.remaining-txt');
    if(!rem){
      rem = document.createElement('div'); rem.className = 'remaining-txt'; rem.style.fontSize='13px'; rem.style.color='var(--text-muted)'; rem.style.marginTop='6px';
      item.querySelector('.content-col').appendChild(rem);
    }
    if(now < s) rem.textContent = `Starts in ${formatHMS(Math.round((s-now)/1000))}`;
    else if(now >= s && now <= e) rem.textContent = `Time left: ${formatHMS(remaining)}`;
    else rem.textContent = 'Ended';
    rem.style.display = showRemainingToggle.checked ? 'block' : 'none';

    // notifications on start transition
    const id = item.dataset.id;
    const isNowCurrent = now >= s && now <= e;
    if(isNowCurrent && !prevStarted[id]){
      // started now
      if(notifyToggle.checked && "Notification" in window && Notification.permission === 'granted'){
        new Notification(item.querySelector('.task-title').innerText.trim(), { body: `${item.dataset.start} ‚Üí ${item.dataset.end}` });
      }
      if(soundToggle.checked) playBeep();
      prevStarted[id] = true;
    }
    if(now > e) prevStarted[id] = false;
  });

  // session remaining sums
  ['morning','afternoon','evening'].forEach(session=>{
    let remSec = 0;
    document.querySelectorAll(`#${session} .item`).forEach(it => {
      const s = parseTime12(it.dataset.start), e = parseTime12(it.dataset.end);
      if(!s||!e) return;
      if(now < s) remSec += (e - s)/1000;
      else if(now >= s && now <= e) remSec += (e - now)/1000;
    });
    const el = document.getElementById(session + 'Remaining');
    if(el) el.textContent = remSec > 0 ? formatHMS(Math.round(remSec)) : '0s';
  });

  const h = Math.floor(dayTotalMins/60), m = dayTotalMins % 60;
  document.getElementById('totalDay').textContent = `Day total: ${h} hr ${m} mins`;
}

/* ------------------ Tabs, controls, extras ------------------ */
document.querySelectorAll('[role="tab"]').forEach(tab=>{
  tab.addEventListener('click', ()=> {
    document.querySelectorAll('[role="tab"]').forEach(t=> t.setAttribute('aria-selected','false'));
    tab.setAttribute('aria-selected','true');
    document.querySelectorAll('.tabpanel').forEach(p=> p.classList.remove('active'));
    document.getElementById(tab.dataset.target).classList.add('active');
  });
});

/* expand/collapse/jump */
document.getElementById('expandAll').addEventListener('click', ()=> document.querySelectorAll('.item').forEach(i=> i.classList.add('open')));
document.getElementById('collapseAll').addEventListener('click', ()=> document.querySelectorAll('.item').forEach(i=> i.classList.remove('open')));
document.getElementById('nowBtn').addEventListener('click', ()=>{
  const cur = document.querySelector('.item.current');
  if(cur){ const tabId = cur.closest('.tabpanel').id; document.querySelector(`[data-target="${tabId}"]`).click(); cur.scrollIntoView({behavior:'smooth', block:'center'}); cur.classList.add('open'); }
  else alert('No active slot right now (check your system clock).');
});

/* attach end-merge handlers dynamically in case items added later */
function attachEndMergeHandlers(){
  document.querySelectorAll('.end-merge-btn').forEach(btn=>{
    if(btn.dataset.bound) return;
    btn.addEventListener('click', (ev)=>{ ev.stopPropagation(); const it = btn.closest('.item'); mergeItemWithNext(it); });
    btn.dataset.bound = '1';
  });
}

/* merge helper (reuse from earlier logic) */
function findNextItem(item){ let n = item.nextElementSibling; while(n && !n.classList.contains('item')) n = n.nextElementSibling; return n; }
function mergeItemWithNext(item){
  const next = findNextItem(item);
  if(!next){ alert('No next consecutive session in this block.'); return; }
  const dur = itemDurationMs(item);
  if(dur <= 0){ animateRemove(item); saveSchedule(); updateAllTimers(); return; }
  if(!confirm(`End "${item.querySelector('.task-title').innerText.trim()}" and add ${Math.round(dur/60000)} mins to "${next.querySelector('.task-title').innerText.trim()}"?`)) return;
  const nextEnd = parseTime12(next.dataset.end);
  if(!nextEnd){ alert('Next slot end invalid.'); return; }
  const newEnd = new Date(nextEnd.getTime() + dur);
  setItemEnd(next, newEnd);
  animateRemove(item);
  saveSchedule(); updateAllTimers();
}

/* call attach on load */
attachEndMergeHandlers();

/* ------------------ load saved schedule/prefs and start timers ------------------ */
loadSchedule();
loadPrefs();
updateAllTimers();
setInterval(updateAllTimers, 1000);
window.addEventListener('beforeunload', saveSchedule);

/* auto-jump if there's current */
setTimeout(()=>{ const cur = document.querySelector('.item.current'); if(cur){ const id = cur.closest('.tabpanel').id; document.querySelector(`[data-target="${id}"]`).click(); cur.scrollIntoView({behavior:'auto', block:'center'}); } }, 500);
</script>
</body>
</html>